pattern <- paste0(
  "=(?<fun>.*?)\n",
  "(?<table>",
  "(?:[^=].*?\n)*",
  ")")
library(namedCapture)
library(data.table)
library(ggplot2)
ploss <- function(dt, x){
  ## need to make a new data table, otherwise ifelse may only get one
  ## element, and return only one element.
  new.dt <- data.table(dt, x)
  new.dt[, ifelse(Log==0, 0, Log*log(x)) + Linear*x + Constant]
}
getLines <- function(dt){
  line.list <- list()
  for(piece.i in 1:nrow(dt)){
    piece <- dt[piece.i,]
    mean.vec <- piece[, seq(exp(min_log_mean), exp(max_log_mean), l=1000)]
    line.list[[piece.i]] <- data.table(
      piece.i,
      piece,
      mean=mean.vec,
      log.mean=log(mean.vec),
      cost=ploss(piece, mean.vec))
  }
  do.call(rbind, line.list)
}
gdata <- function(txt){
  mat <- str_match_all_named(txt, pattern)[[1]]
  funs.list <- list()
  vlines.list <- list()
  coef.list <- list()
  for(row.i in 1:nrow(mat)){
    r <- mat[row.i,]
    df <- read.table(text=r[["table"]], header=TRUE)
    dt <- data.table(df)
    l <- getLines(dt)
    fun <- r[["fun"]]
    coef.list[[fun]] <- dt
    funs.list[[row.i]] <- data.table(fun, l)
    if(1 < nrow(dt)){
      vlines.list[[row.i]] <- data.table(fun, dt[-1,])
    }
  }
  list(
    funs=do.call(rbind, funs.list),
    vlines=do.call(rbind, vlines.list),
    coefs=coef.list)
}

C12.221minless <- gdata("
=prev down cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
5.86959496576579014261e-07 -8.50079270904010946009e-07 -1.68685831242099659733e+00            -inf       -1.465378        0.987110 3021127
2.08471821197888444293e-06 -2.34783798630631605704e-06 -1.68686085317138378947e+00       -1.465378        0.367254        0.987122 3021126
2.46927788214974593505e-06 -3.11695732664804073535e-06 -1.68686112592285875067e+00        0.367254        0.379187        0.987123 3021125
4.35159626772291306760e-06 -6.90183408043494601151e-06 -1.68686244099466198243e+00        0.379187        0.806344        0.987129 3021123
1.92360795015993367224e-04 -4.68474638198672810492e-04 -1.68691133960649652934e+00        0.806344        0.937235        0.987327 3020696
3.47488725165869261069e-02 -9.12466993395298769931e-02 -1.69005057247776369067e+00        0.937235        0.962349        1.003103 2939289
3.49974195034125842851e-02 -9.19108136499326017210e-02 -1.69006211862644395438e+00        0.962349        0.970414        1.003212 2938689
5.71145390940015276748e-02 -1.51403672144096446139e-01 -1.69069730859413858148e+00        0.970414        0.972524        1.015749 2885315
9.66987232234384069818e-02 -2.58905769461704793333e-01 -1.69083370982984626529e+00        0.972524        1.011980        1.640226 2789572
8.75522953081468019443e-03 -2.39900871041822637275e-02 -1.68662737696485054428e+00        1.011980        1.022684        2.358636 2999695
3.41282539288792659271e-03 -9.32055248594855154098e-03 -1.68677432983678676770e+00        1.022684        1.075318        1.659091 3012834
9.43507030772891509482e-04 -2.62729142662469382016e-03 -1.68673432740251127981e+00        1.075318        1.104967        1.974433 3018769
3.17666527543772911433e-04 -8.60887421634077003481e-04 -1.68679665499087660940e+00        1.104967        1.149781        2.182588 3020365
6.84111413251323213129e-06 -1.47549473449767634242e-05 -1.68678809043991217997e+00        1.149781        1.189018        1.449894 3021114
2.09686220156322789660e-05 -6.86337811341785854940e-05 -1.68677042022198442339e+00        1.189018        1.244823        1.520825 3021061
2.11507818593974248418e-05 -6.93624205092391554446e-05 -1.68677014571221572936e+00        1.244823        1.259354        1.521968 3021060
3.88810066525382505586e-05 -1.45464755237788745564e-04 -1.68673677207681516066e+00        1.259354        1.576045        1.978560 3020994
3.91846063921468191127e-05 -1.47286353675440251755e-04 -1.68673536930088441288e+00        1.576045        1.724326        2.008534 3020993
5.86959496576579014261e-07 -8.50079270904010946009e-07 -1.68677138902349255112e+00        1.724326        4.143135             inf 3021128
=min less(prev down cost)
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
5.86959496576579014261e-07 -8.50079270904010946009e-07 -1.68685831242099659733e+00            -inf       -1.465378             inf 3021127
2.08471821197888444293e-06 -2.34783798630631605704e-06 -1.68686085317138378947e+00       -1.465378        0.118861             inf 3021126
0.00000000000000000000e+00 0.00000000000000000000e+00 -1.68685878440024472624e+00        0.118861        0.821618        0.118861 3021126
1.92360795015993367224e-04 -4.68474638198672810492e-04 -1.68691133960649652934e+00        0.821618        0.890109             inf 3020696
0.00000000000000000000e+00 0.00000000000000000000e+00 -1.68685985856159814666e+00        0.890109        0.937444        0.890109 3020696
3.47488725165869261069e-02 -9.12466993395298769931e-02 -1.69005057247776369067e+00        0.937444        0.962349             inf 2939289
3.49974195034125842851e-02 -9.19108136499326017210e-02 -1.69006211862644395438e+00        0.962349        0.965544             inf 2938689
0.00000000000000000000e+00 0.00000000000000000000e+00 -1.68689527269298911172e+00        0.965544        4.143135        0.965544 2938689
")
xi <- 0.992252
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=xi, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)

ggplot()+
  coord_cartesian(ylim=c(-1.68690, -1.68689), xlim=c(0.95, 0.98))+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=xi, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)
