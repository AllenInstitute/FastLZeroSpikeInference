pattern <- paste0(
  "=(?<fun>.*?)\n",
  "(?<table>",
  "(?:[^=].*?\n)*",
  ")")
library(namedCapture)
library(data.table)
library(ggplot2)
ploss <- function(dt, x){
  ## need to make a new data table, otherwise ifelse may only get one
  ## element, and return only one element.
  new.dt <- data.table(dt, x)
  new.dt[, ifelse(Log==0, 0, Log*log(x)) + Linear*x + Constant]
}
getLines <- function(dt){
  line.list <- list()
  for(piece.i in 1:nrow(dt)){
    piece <- dt[piece.i,]
    mean.vec <- piece[, seq(exp(min_log_mean), exp(max_log_mean), l=1000)]
    line.list[[piece.i]] <- data.table(
      piece.i,
      piece,
      mean=mean.vec,
      log.mean=log(mean.vec),
      cost=ploss(piece, mean.vec))
  }
  do.call(rbind, line.list)
}
gdata <- function(txt){
  mat <- str_match_all_named(txt, pattern)[[1]]
  funs.list <- list()
  vlines.list <- list()
  coef.list <- list()
  for(row.i in 1:nrow(mat)){
    r <- mat[row.i,]
    df <- read.table(text=r[["table"]], header=TRUE)
    dt <- data.table(df)
    l <- getLines(dt)
    fun <- r[["fun"]]
    coef.list[[fun]] <- dt
    funs.list[[row.i]] <- data.table(fun, l)
    if(1 < nrow(dt)){
      vlines.list[[row.i]] <- data.table(fun, dt[-1,])
    }
  }
  list(
    funs=do.call(rbind, funs.list),
    vlines=do.call(rbind, vlines.list),
    coefs=coef.list)
}

C12.221minless <- gdata("
=prev up cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
1.43686418759698838988e-04 -1.22995574458302208559e-02 -2.93249317606420845550e+03            -inf        2.649835             inf 27043
6.60957526294614870765e-04 -5.63538134375538846133e-02 -2.93238375982425895927e+03        2.649835        2.777259             inf 27043
6.89694810046554492196e-04 -5.91988045289959172179e-02 -2.93237632049655894662e+03        2.777259        2.805581             inf 27043
7.18432093798494330467e-04 -6.21012701879418357875e-02 -2.93236865261339926292e+03        2.805581        2.907308             inf 27043
7.47169377550433951897e-04 -6.51474222656474588611e-02 -2.93236032261693935652e+03        2.907308        2.939703             inf 27043
7.75906661302373898588e-04 -6.82797861946088935348e-02 -2.93235165782678450341e+03        2.939703        2.964667             inf 27043
8.04643945054313520018e-04 -7.14696246910742072345e-02 -2.93234275818292007898e+03        2.964667        3.029242             inf 27043
8.33381228806253249869e-04 -7.47456750387953394732e-02 -2.93233342856481840499e+03        3.029242        3.059597             inf 27043
9.77067647565952115962e-04 -9.20742571412150184740e-02 -2.93228347333887631976e+03        3.059597        3.156239             inf 27043
1.00580493131789206265e-03 -9.58963158802230430933e-02 -2.93227208481995148759e+03        3.156239        3.369482             inf 27043
1.03454221506983157566e-03 -1.00005747456750365698e-01 -2.93225907337097487471e+03        3.369482        3.544569             inf 27043
1.06327949882177130551e-03 -1.04373814587045241065e-01 -2.93224458547627637017e+03        3.544569        3.584019             inf 27043
1.09201678257371125220e-03 -1.08828093568595865581e-01 -2.93222965631481793025e+03        3.584019        3.720213             inf 27043
1.12075406632565098206e-03 -1.13541008103914070615e-01 -2.93221330934698835335e+03        3.720213        3.913269             inf 27043
1.14949135007759092875e-03 -1.18598770044255424905e-01 -2.93219495562029806024e+03        3.913269        3.960317             inf 27043
1.17822863382953065860e-03 -1.23771481119604578880e-01 -2.93217597800265320984e+03        3.960317        4.053130             inf 27043
1.20696591758147017161e-03 -1.29145353181217364957e-01 -2.93215585161971011985e+03        4.053130        4.095385             inf 27043
1.23570320133340968462e-03 -1.34634174377837784187e-01 -2.93213509881518893962e+03        4.095385        4.262674             inf 27043
1.26444048508534963131e-03 -1.40525317546985439865e-01 -2.93211202712730892017e+03        4.262674        4.423172             inf 27043
1.29317776883729001168e-03 -1.46818782688660248725e-01 -2.93208658559485093065e+03        4.423172        4.505883             inf 27043
1.32191505258922952469e-03 -1.53370883384102568714e-01 -2.93205966470582097827e+03        4.505883        4.545278             inf 27043
1.35065233634116947138e-03 -1.60095407782056470269e-01 -2.93203180653884737694e+03        4.545278        4.680610             inf 27043
1.37938962009310898439e-03 -1.67222254152537552763e-01 -2.93200154745769532383e+03        4.680610        4.759550             inf 27043
1.40812690384504914792e-03 -1.74636473360537947119e-01 -2.93196961256041004162e+03        4.759550        4.833746             inf 27043
5.74745675038795342401e-05 -4.88533823782976057981e-03 -2.93262039525589170808e+03        4.833746        4.840455        4.833746 27043
1.86792344387608482553e-03 -3.25507213058221722690e-01 -2.93129751003447836410e+03        4.840455        4.874170             inf 27043
1.89666072762802498906e-03 -3.37117075694005341457e-01 -2.93124468231041009858e+03        4.874170        4.919289             inf 27043
1.92539801137996450207e-03 -3.48928099316052731105e-01 -2.93119051475943615515e+03        4.919289        5.023267             inf 27043
1.95413529513190379824e-03 -3.61198919478130764382e-01 -2.93113324053845508388e+03        5.023267        5.049975             inf 27043
2.01160986263578412531e-03 -3.86027932639806836690e-01 -2.93101682174821053195e+03        5.049975        5.082536             inf 27043
2.04034714638772407200e-03 -3.98614862923156565433e-01 -2.93095748016149764226e+03        5.082536        5.147066             inf 27043
2.06908443013966358501e-03 -4.11517903327777601064e-01 -2.93089600805453210342e+03        5.147066        5.215139             inf 27043
2.09782171389160353170e-03 -4.24765791137421855339e-01 -2.93083220721017823962e+03        5.215139        5.280621             inf 27043
2.12655899764354304471e-03 -4.38358526352089272748e-01 -2.93076607576950937073e+03        5.280621        5.305223             inf 27043
2.15529628139548342508e-03 -4.52094947985516526501e-01 -2.93069898827693987187e+03        5.305223        5.356610             inf 27043
2.18403356514742250441e-03 -4.66118742456462842316e-01 -2.93062996072406576786e+03        5.356610        5.379399             inf 27043
5.74745675038795342401e-05 -4.88533823782976057981e-03 -2.93264988584957382045e+03        5.379399        5.380136        5.379399 27043
2.21277084889936158374e-03 -4.80286223346169216519e-01 -2.93055997535629558115e+03        5.380136        5.380136             inf 27042
2.21277084889936158374e-03 -4.80286223346169216519e-01 -2.93055997535629467166e+03        5.380136        5.396230             inf 27043
2.21277084889936158374e-03 -4.80286223346169216519e-01 -2.93055997535629558115e+03        5.396230        5.396232             inf 27042
5.74745675038795342401e-05 -4.88533823782976057981e-03 -2.93264994709263010009e+03        5.396232        7.985144        5.396230 27043
=min more(prev up cost)
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
0.00000000000000000000e+00 0.00000000000000000000e+00 -2.93266377665451545909e+03            -inf        5.345964        5.345964 27043
2.15529628139548342508e-03 -4.52094947985516526501e-01 -2.93069898827693987187e+03        5.345964        5.354209             inf 27043
0.00000000000000000000e+00 0.00000000000000000000e+00 -2.93266376124522639657e+03        5.354209        5.363267        5.363267 27043
2.18403356514742250441e-03 -4.66118742456462842316e-01 -2.93062996072406576786e+03        5.363267        5.379399             inf 27043
0.00000000000000000000e+00 0.00000000000000000000e+00 -2.93266369467776394231e+03        5.379399        5.380136        5.380136 27042
2.21277084889936158374e-03 -4.80286223346169216519e-01 -2.93055997535629467166e+03        5.380136        5.396230             inf 27043
2.21277084889936158374e-03 -4.80286223346169216519e-01 -2.93055997535629558115e+03        5.396230        5.396232             inf 27042
5.74745675038795342401e-05 -4.88533823782976057981e-03 -2.93264994709263010009e+03        5.396232        7.985144             inf 27043
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=5.379767, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)

ggplot()+
  coord_cartesian(ylim=c(-2932.6638, -2932.6636), xlim=c(5.35, 5.4))+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=5.379767, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)
## The problem is this interval which is too small, we should not store it
2.21277084889936158374e-03 -4.80286223346169216519e-01 -2.93055997535629558115e+03        5.380136        5.380136             inf 27042

