pattern <- paste0(
  "=(?<fun>.*?)\n",
  "(?<table>",
  "(?:[^=].*?\n)*",
  ")")
library(namedCapture)
library(data.table)
library(ggplot2)
ploss <- function(dt, x){
  ## need to make a new data table, otherwise ifelse may only get one
  ## element, and return only one element.
  new.dt <- data.table(dt, x)
  new.dt[, ifelse(Log==0, 0, Log*log(x)) + Linear*x + Constant]
}
getLines <- function(dt){
  line.list <- list()
  for(piece.i in 1:nrow(dt)){
    piece <- dt[piece.i,]
    mean.vec <- piece[, seq(exp(min_log_mean), exp(max_log_mean), l=1000)]
    line.list[[piece.i]] <- data.table(
      piece.i,
      piece,
      mean=mean.vec,
      log.mean=log(mean.vec),
      cost=ploss(piece, mean.vec))
  }
  do.call(rbind, line.list)
}
gdata <- function(txt){
  mat <- str_match_all_named(txt, pattern)[[1]]
  funs.list <- list()
  vlines.list <- list()
  coef.list <- list()
  for(row.i in 1:nrow(mat)){
    r <- mat[row.i,]
    df <- read.table(text=r[["table"]], header=TRUE)
    dt <- data.table(df)
    l <- getLines(dt)
    fun <- r[["fun"]]
    coef.list[[fun]] <- dt
    funs.list[[row.i]] <- data.table(fun, l)
    if(1 < nrow(dt)){
      vlines.list[[row.i]] <- data.table(fun, dt[-1,])
    }
  }
  list(
    funs=do.call(rbind, funs.list),
    vlines=do.call(rbind, vlines.list),
    coefs=coef.list)
}

C12.221minless <- gdata("
=prev down cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
1.37496545399296836571e-06 -9.62475817795077834825e-06 6.61488096829545457744e-01            -inf        0.199501        2.608691 140362
3.78115499848066316453e-06 -2.19994472638874938514e-05 6.61487628136482874730e-01        0.199501        0.656346        2.615710 140360
4.46863772547714745327e-06 -2.61243436258663978898e-05 6.61489010210511096943e-01        0.656346        1.073033        2.617532 140359
8.76540476920517319908e-06 -5.62017129319625831927e-05 6.61508719459812710717e-01        1.073033        1.408746        2.627620 140358
8.93727545095429490654e-06 -5.75766783859555500761e-05 6.61509953344371015582e-01        1.408746        1.692174        2.627971 140357
1.08278529501946252183e-05 -7.45918758791185194934e-05 6.61528477769024347843e-01        1.692174        1.933442        2.631190 140356
1.09997236319437452317e-05 -7.63105826966097467324e-05 6.61530612601437306708e-01        1.933442        1.936853        2.631424 140355
5.19049458882345354240e-05 -5.04096709570171926627e-04 6.62075416598325694473e-01        1.936853        2.058997        2.854318 140314
5.39673940692239823610e-05 -5.28846087742045425396e-04 6.62110209810574001921e-01        2.058997        2.235541        2.861531 140313
5.41392647509730888218e-05 -5.31080406604783877150e-04 6.62113597466790215762e-01        2.235541        2.397726        2.862033 140312
5.44830061144713898350e-05 -5.35892785693759345945e-04 6.62121355718442550220e-01        2.397726        2.544551        2.862818 140311
5.48267474779696027567e-05 -5.41048906146232946347e-04 6.62130097321446231540e-01        2.544551        2.578477        2.863384 140310
5.55142302049660760340e-05 -5.51533017732929267164e-04 6.62148071365064150307e-01        2.578477        2.677678        2.864414 140308
5.58579715684643296134e-05 -5.57032879548901107593e-04 6.62157796352220717750e-01        2.677678        2.763502        2.864764 140307
1.08450400183695338315e-04 -1.46416633782076163403e-03 6.63830794300759530202e-01        2.763502        2.793617        3.086785 140231
1.08794141547193618999e-04 -1.47069742372722819454e-03 6.63843422914788705569e-01        2.793617        2.896794        3.089309 140230
1.09653494955939205513e-04 -1.48788449190213932852e-03 6.63877642287802549603e-01        2.896794        3.022188        3.093766 140229
1.71870681749121051008e-06 -1.16872063589402303674e-05 6.61632864455713454177e-01        3.022188        3.806662             inf 140362
=min less(prev down cost)
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
1.37496545399296836571e-06 -9.62475817795077834825e-06 6.61488096829545457744e-01            -inf        0.199501             inf 140362
3.78115499848066316453e-06 -2.19994472638874938514e-05 6.61487628136482874730e-01        0.199501        0.656346             inf 140360
4.46863772547714745327e-06 -2.61243436258663978898e-05 6.61489010210511096943e-01        0.656346        1.073033             inf 140359
8.76540476920517319908e-06 -5.62017129319625831927e-05 6.61508719459812710717e-01        1.073033        1.408746             inf 140358
8.93727545095429490654e-06 -5.75766783859555500761e-05 6.61509953344371015582e-01        1.408746        1.692174             inf 140357
1.08278529501946252183e-05 -7.45918758791185194934e-05 6.61528477769024347843e-01        1.692174        1.929910             inf 140356
0.00000000000000000000e+00 0.00000000000000000000e+00 6.61459114052068919420e-01        1.929910        2.058997        1.929910 140356
5.39673940692239823610e-05 -5.28846087742045425396e-04 6.62110209810574001921e-01        2.058997        2.235541             inf 140313
5.41392647509730888218e-05 -5.31080406604783877150e-04 6.62113597466790215762e-01        2.235541        2.283354             inf 140312
0.00000000000000000000e+00 0.00000000000000000000e+00 6.61432033445477851608e-01        2.283354        3.806662        2.283354 140312
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=1.994453, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)

ggplot()+
  coord_cartesian(ylim=c(0.6614, 0.6615), xlim=c(1.9, 2.1))+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=1.994453, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)

