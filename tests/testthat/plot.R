pattern <- paste0(
  "=(?<fun>.*?)\n",
  "(?<table>",
  "(?:[^=].*?\n)*",
  ")")
library(namedCapture)
library(data.table)
library(ggplot2)
ploss <- function(dt, x){
  ## need to make a new data table, otherwise ifelse may only get one
  ## element, and return only one element.
  new.dt <- data.table(dt, x)
  new.dt[, ifelse(Log==0, 0, Log*log(x)) + Linear*x + Constant]
}
getLines <- function(dt){
  line.list <- list()
  for(piece.i in 1:nrow(dt)){
    piece <- dt[piece.i,]
    mean.vec <- piece[, seq(exp(min_log_mean), exp(max_log_mean), l=1000)]
    line.list[[piece.i]] <- data.table(
      piece.i,
      piece,
      mean=mean.vec,
      log.mean=log(mean.vec),
      cost=ploss(piece, mean.vec))
  }
  do.call(rbind, line.list)
}
gdata <- function(txt){
  mat <- str_match_all_named(txt, pattern)[[1]]
  funs.list <- list()
  vlines.list <- list()
  coef.list <- list()
  for(row.i in 1:nrow(mat)){
    r <- mat[row.i,]
    df <- read.table(text=r[["table"]], header=TRUE)
    dt <- data.table(df)
    l <- getLines(dt)
    fun <- r[["fun"]]
    coef.list[[fun]] <- dt
    funs.list[[row.i]] <- data.table(fun, l)
    if(1 < nrow(dt)){
      vlines.list[[row.i]] <- data.table(fun, dt[-1,])
    }
  }
  list(
    funs=do.call(rbind, funs.list),
    vlines=do.call(rbind, vlines.list),
    coefs=coef.list)
}

C12.221minless <- gdata("
=min prev cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
2.80441976555050780442e-04 -1.40220988277525390221e-03 -1.41286148605472683393e+00            -inf        0.591174             inf 1164
5.04795557799091361428e-04 -2.29962420775141644300e-03 -1.41273616463925599795e+00        0.591174        1.397923             inf 1164

1.23394469684222330384e-03 -6.39407706545515753388e-03 -1.40996314519868981563e+00        1.397923        1.459126             inf 1164
7.79628694823041295398e-03 -4.50950698300521535256e-02 -1.38172601379524451204e+00        1.459126        1.579859             inf 1164
8.80587806382859307475e-03 -5.15452352908183225599e-02 -1.37643649170401238813e+00        1.579859        1.766946             inf 1164
9.31067362162768703826e-03 -5.50788041954119733656e-02 -1.37314741002890805532e+00        1.766946        1.777604             inf 1164
0.00000000000000000000e+00  0.00000000000000000000e+00 -1.41597688204853677796e+00        1.777604        4.007333        1.777604 1164
=cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
5.04795557799091361428e-04 -2.29962420775141644300e-03 -1.41273616463925599795e+00            -inf        1.260221             inf 1163

2.21493073083179475846e-01 -8.00269224297493586562e-01 -1.18636713801917492717e+00        1.260221        1.307515            -inf 908

5.04795557799091361428e-04 -2.29962420775141644300e-03 -1.41273616463925599795e+00        1.307515        1.386294             inf 1163

2.80441976555050780442e-04 -1.40220988277525390221e-03 -1.41308283073258267315e+00        1.386294        1.387407        1.386294 1163
4.38050367378989349842e-02 -2.38824387234281176884e-01 -1.25797385683726070660e+00        1.387407        1.456935       -1.126586 1086
2.72028717258399194145e-02 -1.99618598911885186675e-01 -1.24382466354827903032e+00        1.456935        1.575652        0.528125 1098
2.69785181445958872903e-02 -1.98945538168153024383e-01 -1.24380067192877330484e+00        1.575652        1.940757        0.534923 1099
2.63054574008637666316e-02 -1.96253295193224597259e-01 -1.24433845169793788621e+00        1.940757        2.285549        0.717473 1100
2.51276010993325554788e-02 -1.90364013685568544965e-01 -1.24621909011058629169e+00        2.285549        2.506790        0.756896 1101
2.80441976555050780442e-04 -1.40220988277525390221e-03 -1.41514392516325937521e+00        2.506790        4.007333        1.782399 1163
=new cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
2.80441976555050780442e-04 -1.40220988277525390221e-03 -1.41286148605472683393e+00            -inf        0.591174             inf 1164
5.04795557799091361428e-04 -2.29962420775141644300e-03 -1.41273616463925599795e+00        0.591174        1.260221             inf 1164
2.21493073083179475846e-01 -8.00269224297493586562e-01 -1.18636713801917492717e+00        1.260221        1.260221            -inf 908
5.04795557799091361428e-04 -2.29962420775141644300e-03 -1.41273616463925599795e+00        1.260221        1.386294             inf 1164
2.80441976555050780442e-04 -1.40220988277525390221e-03 -1.41308283073258267315e+00        1.386294        1.387407        1.386294 1163
4.38050367378989349842e-02 -2.38824387234281176884e-01 -1.25797385683726070660e+00        1.387407        1.456935       -1.126586 1086
2.72028717258399194145e-02 -1.99618598911885186675e-01 -1.24382466354827903032e+00        1.456935        1.575652        0.528125 1098
2.69785181445958872903e-02 -1.98945538168153024383e-01 -1.24380067192877330484e+00        1.575652        1.940757        0.534923 1099
2.63054574008637666316e-02 -1.96253295193224597259e-01 -1.24433845169793788621e+00        1.940757        2.285549        0.717473 1100
2.51276010993325554788e-02 -1.90364013685568544965e-01 -1.24621909011058629169e+00        2.285549        2.500306        0.756896 1101
0.00000000000000000000e+00 0.00000000000000000000e+00 -1.41597688204853677796e+00        2.500306        4.007333        1.777604 1164
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=1.283868, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)

ggplot()+
  coord_cartesian(ylim=c(-1.415, -1.4125), xlim=c(1, 1.5))+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=1.283868, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)
