pattern <- paste0(
  "=(?<fun>.*?)\n",
  "(?<table>",
  "(?:[^=].*?\n)*",
  ")")
library(namedCapture)
library(data.table)
library(ggplot2)
ploss <- function(dt, x){
  ## need to make a new data table, otherwise ifelse may only get one
  ## element, and return only one element.
  new.dt <- data.table(dt, x)
  new.dt[, ifelse(Log==0, 0, Log*log(x)) + Linear*x + Constant]
}
getLines <- function(dt){
  line.list <- list()
  for(piece.i in 1:nrow(dt)){
    piece <- dt[piece.i,]
    mean.vec <- piece[, {
      min.mean <- exp(min_log_mean)
      max.mean <- if(max_log_mean==Inf){
        min.mean+1
      }else{
        exp(max_log_mean)
      }
      seq(min.mean, max.mean, l=1000)
    }]
    line.list[[piece.i]] <- data.table(
      piece.i,
      piece,
      mean=mean.vec,
      log.mean=log(mean.vec),
      cost=ploss(piece, mean.vec))
  }
  do.call(rbind, line.list)
}
gdata <- function(txt){
  mat <- str_match_all_named(txt, pattern)[[1]]
  funs.list <- list()
  vlines.list <- list()
  coef.list <- list()
  for(row.i in 1:nrow(mat)){
    r <- mat[row.i,]
    df <- read.table(text=r[["table"]], header=TRUE)
    dt <- data.table(df)
    l <- getLines(dt)
    fun <- r[["fun"]]
    coef.list[[fun]] <- dt
    funs.list[[row.i]] <- data.table(fun, l)
    if(1 < nrow(dt)){
      vlines.list[[row.i]] <- data.table(fun, dt[-1,])
    }
  }
  list(
    funs=do.call(rbind, funs.list),
    vlines=do.call(rbind, vlines.list),
    coefs=coef.list)
}

C12.221minless <- gdata("
=min prev cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
5.45454545454545428051e-02 -1.30987292277614866820e-02 -1.42574734396351288090e+00            -inf       -2.519287             inf 335
5.98240469208211125829e-02 -1.83773216031280564597e-02 -1.43947064885462316930e+00       -2.519287       -1.604004             inf 335
9.07135874877810360895e-02 -5.78690127077223850915e-02 -1.50902706182653845168e+00       -1.604004       -1.232176             inf 335
1.04007820136852391357e-01 -7.70283479960899158945e-02 -1.53651209559915513658e+00       -1.232176       -0.662535             inf 335
1.30009775171065489197e-01 -1.22385141739980468634e-01 -1.57996766594013071661e+00       -0.662535       -0.291276             inf 335
1.36265884652981422720e-01 -1.34897360703812307925e-01 -1.58828742050910909356e+00       -0.291276       -0.010094             inf 335
0.00000000000000000000e+00 0.00000000000000000000e+00 -1.45202843104933165819e+00       -0.010094        0.001394       -0.010094 335
2.91300097751710673766e-01 -4.91104594330400490154e-01 -1.74305036253780110123e+00        0.001394        0.113314             inf 335
2.95014662756598267102e-01 -5.00293255131964875737e-01 -1.74616940884759297425e+00        0.113314        0.528169             inf 335
0.00000000000000000000e+00 0.00000000000000000000e+00 -1.51011573079206495862e+00        0.528169             inf        0.528169 335
=cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
1.30987292277614866820e-02 -1.30987292277614866820e-02 -1.42574734396351288090e+00            -inf       -1.455886            -inf 334
9.07135874877810360895e-02 -5.78690127077223850915e-02 -1.50902706182653845168e+00       -1.455886       -1.232176             inf 334
1.04007820136852391357e-01 -7.70283479960899158945e-02 -1.53651209559915513658e+00       -1.232176       -0.662535             inf 334
1.30009775171065489197e-01 -1.22385141739980468634e-01 -1.57996766594013071661e+00       -0.662535       -0.526093             inf 334
1.25708699902248283164e-01 -1.19843597262952100690e-01 -1.57608903246082365790e+00       -0.526093       -0.280620       -0.526093 320
1.36265884652981422720e-01 -1.34897360703812307925e-01 -1.58828742050910909356e+00       -0.280620       -0.011173             inf 334
1.30987292277614866820e-02 -1.30987292277614866820e-02 -1.46512789631113604649e+00       -0.011173        0.001397       -0.011173 334
2.91300097751710673766e-01 -4.91104594330400490154e-01 -1.74305036253780110123e+00        0.001397        0.113314             inf 334
2.95014662756598267102e-01 -5.00293255131964875737e-01 -1.74616940884759297425e+00        0.113314        0.506006             inf 334
2.54349951124144657566e-01 -4.32844574780058832797e-01 -1.71285018819830092696e+00        0.506006        0.571647        0.506006 293
1.30987292277614866820e-02 -1.30987292277614866820e-02 -1.52549687095113628565e+00        0.571647        1.271794        0.547055 334
5.29423264907136092994e-01 -2.76070381231671957423e+00 1.27033489084255685198e-01        1.271794        2.024689            -inf 101
1.30987292277614866820e-02 -1.30987292277614866820e-02 -1.52549687095113628565e+00        2.024689             inf        0.547055 334
=new cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
1.30987292277614866820e-02 -1.30987292277614866820e-02 -1.42574734396351288090e+00            -inf       -1.455886            -inf 334
9.07135874877810360895e-02 -5.78690127077223850915e-02 -1.50902706182653845168e+00       -1.455886       -1.232176             inf 335
1.04007820136852391357e-01 -7.70283479960899158945e-02 -1.53651209559915513658e+00       -1.232176       -0.662535             inf 335
1.30009775171065489197e-01 -1.22385141739980468634e-01 -1.57996766594013071661e+00       -0.662535       -0.526093             inf 335
1.25708699902248283164e-01 -1.19843597262952100690e-01 -1.57608903246082365790e+00       -0.526093       -0.280620       -0.526093 320
1.36265884652981422720e-01 -1.34897360703812307925e-01 -1.58828742050910909356e+00       -0.280620       -0.011173             inf 335
1.30987292277614866820e-02 -1.30987292277614866820e-02 -1.46512789631113604649e+00       -0.011173        0.001397       -0.011173 334
2.91300097751710673766e-01 -4.91104594330400490154e-01 -1.74305036253780110123e+00        0.001397        0.113314             inf 335
2.95014662756598267102e-01 -5.00293255131964875737e-01 -1.74616940884759297425e+00        0.113314        0.506006             inf 335
2.54349951124144657566e-01 -4.32844574780058832797e-01 -1.71285018819830092696e+00        0.506006        0.541104        0.506006 293
0.00000000000000000000e+00 0.00000000000000000000e+00 -1.51011573079206495862e+00        0.541104        1.288954        0.528169 335
5.29423264907136092994e-01 -2.76070381231671957423e+00 1.27033489084255685198e-01        1.288954        1.974894            -inf 101
0.00000000000000000000e+00 0.00000000000000000000e+00 -1.51011573079206495862e+00        1.974894        2.024689        0.528169 335
1.30987292277614866820e-02 -1.30987292277614866820e-02 -1.52549687095113628565e+00        2.024689             inf        0.547055 334
")
xi <- 2.024689
gg <- ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_vline(xintercept=xi, linetype="dashed")+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)
print(gg)

gg+
  coord_cartesian(ylim=c(-1.6, -1.4), xlim=c(0, 2.5))

