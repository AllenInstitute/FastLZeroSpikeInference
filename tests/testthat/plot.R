pattern <- paste0(
  "=(?<fun>.*?)\n",
  "(?<table>",
  "(?:[^=].*?\n)*",
  ")")
library(namedCapture)
library(data.table)
library(ggplot2)
ploss <- function(dt, x){
  ## need to make a new data table, otherwise ifelse may only get one
  ## element, and return only one element.
  new.dt <- data.table(dt, x)
  new.dt[, ifelse(Log==0, 0, Log*log(x)) + Linear*x + Constant]
}
getLines <- function(dt){
  line.list <- list()
  for(piece.i in 1:nrow(dt)){
    piece <- dt[piece.i,]
    mean.vec <- piece[, seq(exp(min_log_mean), exp(max_log_mean), l=1000)]
    line.list[[piece.i]] <- data.table(
      piece.i,
      piece,
      mean=mean.vec,
      log.mean=log(mean.vec),
      cost=ploss(piece, mean.vec))
  }
  do.call(rbind, line.list)
}
gdata <- function(txt){
  mat <- str_match_all_named(txt, pattern)[[1]]
  funs.list <- list()
  vlines.list <- list()
  for(row.i in 1:nrow(mat)){
    r <- mat[row.i,]
    df <- read.table(text=r[["table"]], header=TRUE)
    dt <- data.table(df)
    l <- getLines(dt)
    fun <- r[["fun"]]
    funs.list[[row.i]] <- data.table(fun, l)
    if(1 < nrow(dt)){
      vlines.list[[row.i]] <- data.table(fun, dt[-1,])
    }
  }
  list(
    funs=do.call(rbind, funs.list),
    vlines=do.call(rbind, vlines.list))
}

C12.221minless <- gdata("
=prev up cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
3.42465753424657515236e-03 0.00000000000000000000e+00 1.02112165608683391760e+00            -inf       -0.980724            -inf 290
4.79452054794520521330e-02 -2.39726027397260225971e-02 9.80914189609361164557e-01       -0.980724       -0.372274       -2.197225 277
2.36301369863013699391e-01 -1.81506849315068413686e-01 7.92459732063068189589e-01       -0.372274       -0.120225            -inf 222
9.96575342465753410970e-01 -9.48630136986300720459e-01 2.60814762740953012821e-02       -0.120225        0.031358            -inf 0
3.42465753424657515236e-03 0.00000000000000000000e+00 1.02112165608683391760e+00        0.031358        2.890372            -inf 290
=min more(prev up cost)
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
0.00000000000000000000e+00 0.00000000000000000000e+00 inf            -inf            -inf       -0.049306 0
3.42465753424657515236e-03 0.00000000000000000000e+00 1.02112165608683391760e+00            -inf       -2.244663             inf 290
0.00000000000000000000e+00 0.00000000000000000000e+00 1.02148454405700839231e+00       -2.244663       -0.049306       -0.049306 0
9.96575342465753410970e-01 -9.48630136986300720459e-01 2.60814762740953012821e-02       -0.049306        0.031358             inf 0
3.42465753424657515236e-03 0.00000000000000000000e+00 1.02112165608683391760e+00        0.031358        2.890372             inf 290
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minless$vlines)+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minless$funs)

C12.221minenv <- gdata("
=min prev cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
0.00000000000000000000e+00 0.00000000000000000000e+00 3.89706118994612604745e-01            -inf        1.791759        1.791759 220
1.39799792889195705764e-02 -8.38798757335174338667e-02 4.56118804884297623925e-01        1.791759        2.079442             inf 220
=cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
3.45184673800483243517e-04 -2.41629271660338254199e-03 3.91963697043091530148e-01            -inf        1.787531        1.787531 219
1.39799792889195705764e-02 -8.38798757335174338667e-02 4.56118804884297623925e-01        1.787531        2.079442             inf 219
=new cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
0.00000000000000000000e+00 0.00000000000000000000e+00 3.89706118994612604745e-01            -inf        1.791759        1.791759 220
1.39799792889195705764e-02 -8.38798757335174338667e-02 4.56118804884297623925e-01        1.791759        2.079442             inf 220
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.221minenv$vlines)+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.221minenv$funs)

C12.222minless <- gdata("
=prev cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
8.62515094014145214905e-04 -5.52009660169052937539e-03 4.21684062962702055355e-01            -inf        0.771047             inf 220
1.70777988614800764477e-02 -9.38416422287390028512e-02 4.54726201717920386347e-01        0.771047        0.990736        0.359236 210
1.62152837674659315581e-02 -9.21166120407107130719e-02 4.55340091363766408250e-01        0.990736        1.675337        0.366340 211
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.675337        2.099627        0.403148 212
1.13851992409867135841e-02 -7.45213041228221378942e-02 4.55151876163122581787e-01        2.099627        2.403213        0.497005 213
9.48766603415559552082e-03 -6.50336380886665371692e-02 4.53335149941434201182e-01        2.403213        2.634725        0.565457 214
6.72761773331033256784e-03 -4.84733482835949594514e-02 4.48176980505424482626e-01        2.634725        2.727256        0.674965 215
4.65758150767638448575e-03 -3.48456097981714590928e-02 4.42663314403452468060e-01        2.727256        2.728005        0.753601 217
5.17509056408487128943e-04 -3.10505433845092299050e-03 4.19427653231308816828e-01        2.728005        4.499810        1.791759 220
=min prev cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
0.00000000000000000000e+00 0.00000000000000000000e+00 3.87045986373758976740e-01            -inf        1.791759        1.791759 221
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.099627             inf 221
1.13851992409867135841e-02 -7.45213041228221378942e-02 4.55151876163122581787e-01        2.099627        2.403213             inf 221
9.48766603415559552082e-03 -6.50336380886665371692e-02 4.53335149941434201182e-01        2.403213        2.634725             inf 221
6.72761773331033256784e-03 -4.84733482835949594514e-02 4.48176980505424482626e-01        2.634725        2.727256             inf 221
4.65758150767638448575e-03 -3.48456097981714590928e-02 4.42663314403452468060e-01        2.727256        2.728005             inf 221
5.17509056408487128943e-04 -3.10505433845092299050e-03 4.19427653231308816828e-01        2.728005        4.499810             inf 221
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.222minless$vlines)+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.222minless$funs)

C12.222minenv <- gdata("
=min prev cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
0.00000000000000000000e+00 0.00000000000000000000e+00 3.87045986373758976740e-01            -inf        1.791759        1.791759 221
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.099627             inf 221
1.13851992409867135841e-02 -7.45213041228221378942e-02 4.55151876163122581787e-01        2.099627        2.403213             inf 221
9.48766603415559552082e-03 -6.50336380886665371692e-02 4.53335149941434201182e-01        2.403213        2.634725             inf 221
6.72761773331033256784e-03 -4.84733482835949594514e-02 4.48176980505424482626e-01        2.634725        2.727256             inf 221
4.65758150767638448575e-03 -3.48456097981714590928e-02 4.42663314403452468060e-01        2.727256        2.728005             inf 221
5.17509056408487128943e-04 -3.10505433845092299050e-03 4.19427653231308816828e-01        2.728005        4.499810             inf 221
=cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
5.17509056408487128943e-04 -3.10505433845092299050e-03 3.89504442548695095638e-01            -inf        1.791759        1.791759 220
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.099627             inf 220
1.13851992409867135841e-02 -7.45213041228221378942e-02 4.55151876163122581787e-01        2.099627        2.403213             inf 220
9.48766603415559552082e-03 -6.50336380886665371692e-02 4.53335149941434201182e-01        2.403213        2.634725             inf 220
6.72761773331033256784e-03 -4.84733482835949594514e-02 4.48176980505424482626e-01        2.634725        2.727256             inf 220
4.65758150767638448575e-03 -3.48456097981714590928e-02 4.42663314403452468060e-01        2.727256        2.759925             inf 220
8.62515094014145214905e-04 -5.52009660169052937539e-03 4.21684062962702055355e-01        2.759925        4.499810             inf 220
=new cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
5.17509056408487128943e-04 -3.10505433845092299050e-03 3.89504442548695095638e-01            -inf        1.791759        1.791759 220
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        1.791759             inf 220
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.099627             inf 221
1.13851992409867135841e-02 -7.45213041228221378942e-02 4.55151876163122581787e-01        2.099627        2.403213             inf 221
9.48766603415559552082e-03 -6.50336380886665371692e-02 4.53335149941434201182e-01        2.403213        2.634725             inf 221
6.72761773331033256784e-03 -4.84733482835949594514e-02 4.48176980505424482626e-01        2.634725        2.727256             inf 221
4.65758150767638448575e-03 -3.48456097981714590928e-02 4.42663314403452468060e-01        2.727256        2.728005             inf 221
5.17509056408487128943e-04 -3.10505433845092299050e-03 4.19427653231308816828e-01        2.728005        4.499810             inf 221
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.222minenv$vlines)+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.222minenv$funs)
## peak 6 in better model ends on data point 222 in R (221 in C), but
## in the worse model it ends in 221 in R (220 in C).

## Problem seems to be related to creating this very small interval
## 1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        1.791759             inf 220
## 1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.099627             inf 221

C12.222minless <- gdata("
=prev cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
8.62515094014145214905e-04 -5.52009660169052937539e-03 4.21684062962702055355e-01            -inf        0.771047             inf 220
1.70777988614800764477e-02 -9.38416422287390028512e-02 4.54726201717920386347e-01        0.771047        0.990736        0.359236 210
1.62152837674659315581e-02 -9.21166120407107130719e-02 4.55340091363766408250e-01        0.990736        1.675337        0.366340 211
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.675337        2.079442        0.403148 212
=min prev cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
0.00000000000000000000e+00 0.00000000000000000000e+00 3.87045986373758976740e-01            -inf        1.791759        1.791759 221
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.079442             inf 221
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.222minless$vlines)+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.222minless$funs)

C12.222minenv <- gdata("
=min prev cost
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
0.00000000000000000000e+00 0.00000000000000000000e+00 3.87045986373758976740e-01            -inf        1.791759        1.791759 221
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.079442             inf 221
=cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
5.17509056408487128943e-04 -3.10505433845092299050e-03 3.89504442548695095638e-01            -inf        1.791759        1.791759 220
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.079442             inf 220
=new cost model
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
5.17509056408487128943e-04 -3.10505433845092299050e-03 3.89504442548695095638e-01            -inf        1.791759        1.791759 220
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        1.791759             inf 220
1.44902535794376365746e-02 -8.69415214766258437340e-02 4.55882759271971804704e-01        1.791759        2.079442             inf 221
=after
    Linear        Log        Constant    min_log_mean    max_log_mean   prev_log_mean data_i
1.03448275862068946734e-03 -5.68965517241379250407e-03 3.89302974733583717626e-01            -inf        1.791759        1.791759 220
1.49999999999999959754e-02 -8.94827586206896480325e-02 4.55646957844762112710e-01        1.791759        1.791759             inf 220
1.49999999999999959754e-02 -8.94827586206896480325e-02 4.55646957844762112710e-01        1.791759        2.079442             inf 221
")
ggplot()+
  geom_vline(aes(xintercept=min_log_mean, color=fun),
             data=C12.222minenv$vlines)+
  geom_line(aes(log.mean, cost, color=fun),
            size=2,
            data=C12.222minenv$funs)
